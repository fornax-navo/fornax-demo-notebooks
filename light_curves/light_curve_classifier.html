
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Light Curve Classifier &#8212; Fornax Demo Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'light_curves/light_curve_classifier';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/fornax_logo.png" class="logo__image only-light" alt="Fornax Demo Notebooks - Home"/>
    <script>document.write(`<img src="../_static/fornax_logo.png" class="logo__image only-dark" alt="Fornax Demo Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/fornax-navo/fornax-demo-notebooks" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Tutorial Notebooks
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../forced_photometry/README.html">Multi-band forced photometry</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../forced_photometry/multiband_photometry.html">Automated Multiband Forced Photometry on Large Datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="README.html">Time Domain</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="light_curve_generator.html">Make Multi-Wavelength Light Curves Using Archival Data</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../documentation/README.html">Fornax Science Console</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fornax-navo/fornax-demo-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fornax-navo/fornax-demo-notebooks/edit/main/light_curves/light_curve_classifier.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fornax-navo/fornax-demo-notebooks/issues/new?title=Issue%20on%20page%20%2Flight_curves/light_curve_classifier.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/light_curves/light_curve_classifier.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Light Curve Classifier</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-a-dataset-of-archival-light-curves">1. Read in a dataset of archival light curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-prep">2. Data Prep</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-bands-with-not-enough-data">2.1 Remove bands with not enough data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-labels-for-a-simpler-classification">2.2 Combine Labels for a Simpler Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-visualization">2.3 Data Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-the-dataset-of-unwanted-data">2.4 Clean the dataset of unwanted data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-data">2.5 Missing Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing">2.6  Make all objects and bands have identical time arrays (uniform length and spacing)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restructure-dataframe">2.7  Restructure dataframe</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize">2.8 Normalize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleanup">2.9 Cleanup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prep-for-ml-algorithms">3. Prep for ML algorithms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split">3.1 Train test split</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-sktime-algorithms-on-the-light-curves">4. Run sktime algorithms on the light curves</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-that-the-data-types-are-ok-for-sktime">4.1 Check that the data types are ok for sktime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-single-classifier">4.1 A single Classifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-a-bunch-of-classifiers">4.2 Loop over a bunch of classifiers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-candidate-list">5.0 Create a candidate list</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References:</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="light-curve-classifier">
<h1>Light Curve Classifier<a class="headerlink" href="#light-curve-classifier" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h2>
<p>By the end of this tutorial, you will be able to:</p>
<ul class="simple">
<li><p>prepare data for ML algorithms by cleaning and filtering the dataset</p></li>
<li><p>work with Pandas dataframes as a way of storing and manipulating time domain datasets</p></li>
<li><p>use <a class="reference external" href="https://www.sktime.net/en/stable/index.html">sktime</a> algorithms to train a classifier and calculate metrics of accuracy</p></li>
<li><p>use the trained classifier to predict labels on an unlabelled dataset</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>The science goal of this notebook is to find a classifier that can accurately discern changing look active galactic nuclei (CLAGN) from a broad sample of all Sloan Digital Sky Survey (SDSS) identified Quasars (QSOs) based solely on archival photometry in the form of multiwavelength light curves.</p>
<p>CLAGN are astrophysically interesting objects because they appear to change state.  CLAGN are characterized by the appearance or disappearance of broad emission lines on timescales of order months.  Astronomers would like to understand the physical mechanism behind this apparent change of state.  However, only a few hundered CLAGN are known, and finding CLAGN is observationally expensive, traditionally requiring multiple epochs of spectroscopy.  Being able to identify CLAGN in existing, archival, large, photometric samples would allow us to identify a statisitcally significant sample from which we could better understand the underlying physics.</p>
<p>This notebook walks through an exercise in using multiwavelength photometry(no spectroscopy) to learn if we can identify CLAGN based on their light curves alone.  If we are able to find a classifier that can differentiate CLAGN from SDSS QSOs, we would then be able to run the entire sample of SDSS QSOs (~500,000) to find additional CLAGN candidates for follow-up verification.</p>
<p>Input to this notebook is output of a previous demo notebook which generates multiwavelength light curves from archival data.  THis notebook starts with light curves, does data prep, and runs the light curves through multiple ML classification algorithms.  There are many ML algorthms to choose from; We choose to use sktime algorithms for time domain classification beacuse it is a library of many algorithms specifically tailored to time series datasets.  It is based on the <a class="reference external" href="https://scikit-learn.org/stable/index.html">scikit-learn</a> library so syntax is familiar to many users.</p>
<p>The challenges of this time-domain dataset for ML work are:</p>
<ol class="arabic simple">
<li><p>Multi-variate = There are multiple bands of observations per target (13+)</p></li>
<li><p>Unequal length = Each band has a light curve with different sampling than other bands</p></li>
<li><p>Missing data = Not each object has all observations in all bands</p></li>
</ol>
</section>
<section id="input">
<h2>Input<a class="headerlink" href="#input" title="Link to this heading">#</a></h2>
<p>Light curve parquet file of multiwavelength light curves from the light_curve_generator.md demo notebook in this same repo.  The format of the light curves is a Pandas multiindex data frame.</p>
<p>We choose to use a Pandas multiindex dataframe to store and work with the data because it fulfills these requirements:</p>
<ol class="arabic simple">
<li><p>It can handle the above challenges of a dataset = multi-variate, unqueal length with missing data.</p></li>
<li><p>Multiple targets (multiple rows)</p></li>
<li><p>Pandas has some built in understanding of time units</p></li>
<li><p>Can be scaled up to big data numbers of rows (altough we don’t push to out of memory structures in this use case)</p></li>
<li><p>Pandas is user friendly with a lot of existing functionality</p></li>
</ol>
<p>A useful reference for what sktime expects as input to its ML algorithms: https://github.com/sktime/sktime/blob/main/examples/AA_datatypes_and_datasets.ipynb</p>
</section>
<section id="output">
<h2>Output<a class="headerlink" href="#output" title="Link to this heading">#</a></h2>
<p>Trained classifiers as well as estimates of their accuracy and plots of confusion matrices</p>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pandas</span></code> to work with light curve data structure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> for numerical calculations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> for plotting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sys</span></code> for paths</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy</span></code> to work with coordinates/units and data structures</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tqdm</span></code> for showing progress meter</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sktime</span></code> ML algorithms specifically for time-domain data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sklearn</span></code> general use ML algorthims with easy to use interface</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scipy</span></code> for statistical analysis</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">json</span></code> for storing intermediate files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">google_drive_downloader</span></code> to access files stored in google drive</p></li>
</ul>
</section>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h2>
<p>Jessica Krick, Shooby Hemmati, Troy Raen, Brigitta Sipocz, Andreas Faisst, Vandana Desai, Dave Shoop</p>
</section>
<section id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Link to this heading">#</a></h2>
<p>Stephanie La Massa</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#insure all dependencies are installed</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">-</span><span class="n">lc_classifier</span><span class="o">.</span><span class="n">txt</span>
<span class="c1">#need updated version of astropy, so this is here temporarily to make sure we grab that.</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">astropy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">google_drive_downloader</span> <span class="kn">import</span> <span class="n">GoogleDriveDownloader</span> <span class="k">as</span> <span class="n">gdd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sigmaclip</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">RBF</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">matthews_corrcoef</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.cluster</span> <span class="kn">import</span> <span class="n">completeness_score</span><span class="p">,</span> <span class="n">homogeneity_score</span>

<span class="kn">from</span> <span class="nn">sktime.classification.deep_learning</span> <span class="kn">import</span> <span class="n">CNNClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.dictionary_based</span> <span class="kn">import</span> <span class="n">IndividualTDE</span>
<span class="kn">from</span> <span class="nn">sktime.classification.distance_based</span> <span class="kn">import</span> <span class="n">KNeighborsTimeSeriesClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.ensemble</span> <span class="kn">import</span> <span class="n">WeightedEnsembleClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.feature_based</span> <span class="kn">import</span> <span class="n">Catch22Classifier</span><span class="p">,</span> <span class="n">RandomIntervalClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.hybrid</span> <span class="kn">import</span> <span class="n">HIVECOTEV2</span>
<span class="kn">from</span> <span class="nn">sktime.classification.interval_based</span> <span class="kn">import</span> <span class="n">CanonicalIntervalForest</span>
<span class="kn">from</span> <span class="nn">sktime.classification.kernel_based</span> <span class="kn">import</span> <span class="n">Arsenal</span><span class="p">,</span> <span class="n">RocketClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.shapelet_based</span> <span class="kn">import</span> <span class="n">ShapeletTransformClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.registry</span> <span class="kn">import</span> <span class="n">all_estimators</span><span class="p">,</span> <span class="n">all_tags</span>
<span class="kn">from</span> <span class="nn">sktime.datatypes</span> <span class="kn">import</span> <span class="n">check_is_mtype</span>

<span class="c1"># local code imports</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;code_src/&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">fluxconversions</span> <span class="kn">import</span> <span class="n">mjd_to_jd</span>

<span class="c1">#improves memory usage</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">copy_on_write</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-a-dataset-of-archival-light-curves">
<h2>1. Read in a dataset of archival light curves<a class="headerlink" href="#read-in-a-dataset-of-archival-light-curves" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#access structure of light curves made in the light curve generator notebook</span>
<span class="c1"># has known CLAGN &amp; random SDSS small sample of targets, all bands</span>
<span class="n">savename_df_lc</span> <span class="o">=</span> <span class="s1">&#39;./data/small_CLAGN_SDSS_df_lc.parquet&#39;</span>
<span class="n">gdd</span><span class="o">.</span><span class="n">download_file_from_google_drive</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="s1">&#39;1DrB-CWdBBBYuO0WzNnMl5uQnnckL7MWH&#39;</span><span class="p">,</span>
                                    <span class="n">dest_path</span><span class="o">=</span><span class="n">savename_df_lc</span><span class="p">,</span>
                                    <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df_lc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">savename_df_lc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#get rid of indices set in the light curve code and reset them as needed before sktime algorithms</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  

<span class="c1">#what does the dataset look like at the start?</span>
<span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-prep">
<h2>2. Data Prep<a class="headerlink" href="#data-prep" title="Link to this heading">#</a></h2>
<p>The majority of work in all ML projects is preparing and cleaning the data.  As most do, this dataset needs significant work before it can be fed into a ML algorithm.  Data preparation includes everything from removing statistical outliers to putting it in the correct data format for the algorithms.</p>
<section id="remove-bands-with-not-enough-data">
<h3>2.1 Remove bands with not enough data<a class="headerlink" href="#remove-bands-with-not-enough-data" title="Link to this heading">#</a></h3>
<p>For this use case of CLAGN classification, we don’t need to include some of the bands
that are known to be sparse.  Most ML algorithms cannot handle sparse data so one way to accomodate that
is to remove the sparsest datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">##what are the unique set of bands included in our light curves</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># get rid of some of the bands that don&#39;t have enough data for all the sources</span>
<span class="c1">#CLAGN are generall fainter targets, and therefore mostly not found in datasets like TESS &amp; K2</span>

<span class="n">bands_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;IceCube&quot;</span><span class="p">,</span> <span class="s2">&quot;TESS&quot;</span><span class="p">,</span> <span class="s2">&quot;FERMIGTRIG&quot;</span><span class="p">,</span> <span class="s2">&quot;K2&quot;</span><span class="p">]</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span><span class="o">~</span><span class="n">df_lc</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bands_to_drop</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="combine-labels-for-a-simpler-classification">
<h3>2.2 Combine Labels for a Simpler Classification<a class="headerlink" href="#combine-labels-for-a-simpler-classification" title="Link to this heading">#</a></h3>
<p>All CLAGN start in the dataset as having labels based on their discovery paper.  Because we want one sample with all known CLAGN, we change those discovery names to be simply “CLAGN” for all CLAGN, regardless of origin.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MacLeod 16&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;LaMassa 15&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Yang 18&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Lyu 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hon 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Sheng 20&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MacLeod 19&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Green 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Lopez-Navas 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n objects before removing missing band data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-visualization">
<h3>2.3 Data Visualization<a class="headerlink" href="#data-visualization" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>can we see any trends by examining plots of a subset of the data?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#chhose your own adventure, the bands from which you can choose are:</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot a single band for all objects</span>
<span class="n">band_of_interest</span> <span class="o">=</span> <span class="s1">&#39;zr&#39;</span>
<span class="n">band_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">band_of_interest</span><span class="p">]</span>
<span class="c1">#reset zero time to be start of that mission</span>
<span class="n">band_lc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_lc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_lc</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">band_lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">band_lc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1">#helps with the plotting</span>

<span class="c1">#drop some objects to try to clear up plot</span>
<span class="n">querystring1</span> <span class="o">=</span> <span class="s1">&#39;objectid &lt; 162&#39;</span>
<span class="n">querystring2</span> <span class="o">=</span> <span class="s1">&#39;objectid &gt; 200&#39;</span>
<span class="n">band_lc</span> <span class="o">=</span> <span class="n">band_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">band_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring1</span> <span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">band_lc</span> <span class="o">=</span> <span class="n">band_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">band_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring2</span> <span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1">#quick normalization for plotting</span>
<span class="c1">#we normalize for real after cleaning the data</span>
<span class="c1"># make a new column with max_r_flux for each objectid</span>
<span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;mean_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;objectid&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;sigma_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;objectid&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;flux&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;std&#39;</span><span class="p">)</span>

<span class="c1">#choose to normalize (flux - mean) / sigma</span>
<span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;mean_band&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;sigma_band&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#want to have two different sets so I can color code</span>
<span class="n">clagn_df</span> <span class="o">=</span> <span class="n">band_lc</span><span class="p">[</span><span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">]</span>
<span class="n">sdss_df</span> <span class="o">=</span> <span class="n">band_lc</span><span class="p">[</span><span class="n">band_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SDSS&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">clagn_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n objects CLAGN &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sdss_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n objects SDSS &quot;</span><span class="p">)</span>

<span class="c1">#groupy objectid &amp; plot flux vs. time</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">lc_sdss</span> <span class="o">=</span> <span class="n">sdss_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;objectid&#39;</span><span class="p">])[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SDSS&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">lc_clagn</span> <span class="o">=</span> <span class="n">clagn_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;objectid&#39;</span><span class="p">])[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">#add legend and labels/titles</span>
<span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;CLAGN&#39;</span><span class="p">),</span>
                   <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SDSS&#39;</span><span class="p">)]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Flux&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time in days since start of mission&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">band_of_interest</span><span class="si">}</span><span class="s2"> light curves&quot;</span><span class="p">)</span>

<span class="c1">#tailored to ZTF r band with lots of data</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1250</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="clean-the-dataset-of-unwanted-data">
<h3>2.4 Clean the dataset of unwanted data<a class="headerlink" href="#clean-the-dataset-of-unwanted-data" title="Link to this heading">#</a></h3>
<p>“unwanted” includes:</p>
<ul class="simple">
<li><p>NaNs</p>
<ul>
<li><p>SKtime does not work with NaNs</p></li>
</ul>
</li>
<li><p>zero flux</p>
<ul>
<li><p>there are a few flux measurements that come into our dataframe with zeros.  It is not clear what these are, and zero will be used to mean lack of observation in the rest of this notebook, so want to drop these rows at the outset.</p></li>
</ul>
</li>
<li><p>outliers in uncertainty</p>
<ul>
<li><p>This is a tricky job because we want to keep astrophysical sources that are variable objects, but remove instrumental noise and CR (ground based).  The user will need to choose a sigma clipping threshold, and there is some plotting functionality available to help users make that decision</p></li>
</ul>
</li>
<li><p>objects with no measurements in WISE W1 band</p>
<ul>
<li><p>Below we want to normalize all light curves by W1, so we neeed to remove those objects without W1 fluxes because there will be nothing to normalize those light curves with.  We don’t want to have un-normalized data.</p></li>
</ul>
</li>
<li><p>objects with incomplete data</p>
<ul>
<li><p>Incomplete is defined here as not enough flux measurements to make a good light curve.  Some bands in some objects have only a few datapoints. Three data points is not large enough for KNN interpolation, so we will consider any array with fewer than 4 photometry points to be incomplete data.  Another way of saying this is that we choose to remove those light curves with 3 or
fewer data points.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sigmaclip_lightcurves</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">sigmaclip_value</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">include_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sigmaclip to remove bad values from the light curves; optionally plots histograms of uncertainties</span>
<span class="sd">        to help determine sigmaclip_value from the data. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>
<span class="sd">   </span>
<span class="sd">    sigmaclip_value: float</span>
<span class="sd">        what value of sigma should be used to make the cuts</span>

<span class="sd">    include_plot: bool</span>
<span class="sd">        have the function plot histograms of uncertainties for each band</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    df_lc: MultiIndexDFObject with all  light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#keep track of how many rows this removes</span>
    <span class="n">start_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1">#setup to collect the outlier thresholds per band to later reject</span>
    <span class="n">nsigmaonmean</span><span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">include_plot</span><span class="p">:</span>
        <span class="c1">#create the figure and axes</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

        <span class="c1"># unpack all the axes subplots</span>
        <span class="n">axe</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1">#for each band</span>
    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">bandname</span><span class="p">,</span> <span class="n">singleband</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)):</span>
    
        <span class="c1">#use scipy sigmaclip to iteratively determine sigma on the dataset</span>
        <span class="n">clippedarr</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">sigmaclip</span><span class="p">(</span><span class="n">singleband</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">sigmaclip_value</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">sigmaclip_value</span><span class="p">)</span>
    
        <span class="c1">#store this value for later</span>
        <span class="n">nsigmaonmean</span><span class="p">[</span><span class="n">bandname</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
    
        <span class="k">if</span> <span class="n">include_plot</span><span class="p">:</span>        
            <span class="c1">#plot distributions and print stddev</span>
            <span class="n">singleband</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">subplots</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axe</span><span class="p">[</span><span class="n">count</span><span class="p">],</span><span class="n">label</span> <span class="o">=</span> <span class="n">bandname</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">upper</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#remove data that are outside the sigmaclip_value</span>
    <span class="c1">#make one large querystring joined by &quot;or&quot; for all bands in df_lc</span>
    <span class="n">querystring</span> <span class="o">=</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(band == </span><span class="si">{</span><span class="n">bandname</span><span class="si">!r}</span><span class="s1"> &amp; err &gt; </span><span class="si">{</span><span class="n">cut</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">for</span> <span class="n">bandname</span><span class="p">,</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">nsigmaonmean</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">clipped_df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1">#how much data did we remove with this sigma clipping?</span>
    <span class="c1">#This should inform our choice of sigmaclip_value.</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">end_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clipped_df_lc</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="p">((</span><span class="n">start_len</span> <span class="o">-</span> <span class="n">end_len</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_len</span><span class="p">)</span> <span class="o">*</span><span class="mf">100.</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This </span><span class="si">{</span><span class="n">sigmaclip_value</span><span class="si">}</span><span class="s2"> sigma clipping removed </span><span class="si">{</span><span class="n">fraction</span><span class="si">}</span><span class="s2">% of the rows in df_lc&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clipped_df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_objects_without_band</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">bandname_to_keep</span> <span class="o">=</span> <span class="s2">&quot;W1&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># drop objects that do not have data in the band bandname_to_keep</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop objects that do not have data in the band bandname_to_keep.  This is needed for normalization.  </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    bandname_to_keep: str &quot;w1&quot;</span>

<span class="sd">    verbose: should the function provide feedback</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    drop_df_lc: MultiIndexDFObject with all  light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#remove objects without bandname_to_keep by filtering the dataframe grouped by objectid</span>
    <span class="n">drop_df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;objectid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">bandname_to_keep</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1">#if you want to track how many objects were removed by this function...</span>
        <span class="n">dropcount</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ngroups</span> <span class="o">-</span> <span class="n">drop_df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ngroups</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">dropcount</span><span class="p">,</span> <span class="s2">&quot;objects without&quot;</span><span class="p">,</span> <span class="n">bandname_to_keep</span><span class="p">,</span> <span class="s2">&quot; were removed&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">drop_df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_incomplete_data</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">threshold_too_few</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove those light curves that don&#39;t have enough data for classification.</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    threshold_too_few: Int</span>
<span class="sd">        Define what the threshold is for too few datapoints.</span>
<span class="sd">        Default is 3</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    df_lc: MultiIndexDFObject with all  light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#how many groups do we have before we start</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n groups before removing incomplete data&quot;</span><span class="p">)</span>

    <span class="c1">#use pandas .filter to remove small groups</span>
    <span class="n">complete_df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold_too_few</span><span class="p">)</span>

    <span class="c1">#how many groups do we have after culling?</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">complete_df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n groups after removing incomplete data&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">complete_df_lc</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#drop rows which have Nans</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#drop rows with zero flux</span>
<span class="n">querystring</span> <span class="o">=</span> <span class="s1">&#39;flux &lt; 0.000001&#39;</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1">#remove outliers</span>
<span class="n">sigmaclip_value</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">sigmaclip_lightcurves</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">sigmaclip_value</span><span class="p">,</span> <span class="n">include_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n objects after sigma clipping&quot;</span><span class="p">)</span>

<span class="c1">#remove incomplete data</span>
<span class="n">threshold_too_few</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">remove_incomplete_data</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">threshold_too_few</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1">#remove objects without W1 fluxes</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">remove_objects_without_band</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n objects after cleaning the data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="missing-data">
<h3>2.5 Missing Data<a class="headerlink" href="#missing-data" title="Link to this heading">#</a></h3>
<p>Some objects do not have light curves in all bands.  Some ML algorithms can handle mising data, but not all, so we try to do something intentional and sensible to handle this missing data up front.</p>
<p>There are two options here:</p>
<ol class="arabic simple">
<li><p>We will add light curves with zero flux and err values for the missing data.  SKtime does not like NaNs, so we choose zeros.  This option has the benefit of including more bands and therefore more information, but the drawback of having some objects have bands with entire arrays of zeros.</p></li>
<li><p>Remove bands which have less data from all objects so that there are no objects with missing data.  This has the benefit of less zeros, but the disadvantage of throwing away some information for the few objects which do have light curves in the bands which will be removed.</p></li>
</ol>
<p>Functions are inlcuded for both options.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_zero_light_curve</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make placeholder light curves with flux and err values = 0.0.</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    oid: Int</span>
<span class="sd">        objectid</span>
<span class="sd">    band: string</span>
<span class="sd">        photometric band name</span>
<span class="sd">    label: string</span>
<span class="sd">        value for ML algorithms which details what kind of object this is</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    zerosingle: dictionary with light curve info</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#randomly choose some times during the WISE survey</span>
    <span class="c1">#these will all get fleshed out in the section on making uniform length time arrays</span>
    <span class="c1">#so the specifics are not important now</span>
    <span class="n">timelist</span> <span class="o">=</span> <span class="p">[</span><span class="mf">55230.0</span><span class="p">,</span><span class="mf">57054.0</span><span class="p">,</span> <span class="mf">57247.0</span><span class="p">,</span> <span class="mf">57977.0</span><span class="p">,</span> <span class="mf">58707.0</span><span class="p">]</span>  
    
    <span class="c1">#make a dictionary to hold the light curve</span>
    <span class="n">zerosingle</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;objectid&quot;</span><span class="p">:</span> <span class="n">oid</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">band</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">timelist</span><span class="p">,</span> 
                  <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timelist</span><span class="p">)),</span> <span class="s2">&quot;err&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timelist</span><span class="p">))}</span>
    
    <span class="k">return</span> <span class="n">zerosingle</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">missingdata_to_zeros</span><span class="p">(</span><span class="n">df_lc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert mising data into zero fluxes and uncertainties</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    df_lc: MultiIndexDFObject with all  light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#what is the full set of unique band names?</span>
    <span class="n">full_bandname</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1">#setup a list to store empty light curves</span>
    <span class="n">zerosingle_list</span> <span class="o">=</span> <span class="p">[]</span> 

    <span class="c1">#for each object in each band</span>
    <span class="k">for</span> <span class="n">oid</span> <span class="p">,</span> <span class="n">singleoid</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">):</span>
                                  
        <span class="c1">#this is the list of bandnames for that object                                </span>
        <span class="n">oid_bandname</span> <span class="o">=</span> <span class="n">singleoid</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
        <span class="c1">#figure out which bands are missing</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">full_bandname</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">oid_bandname</span><span class="p">))</span>
    
        <span class="c1">#if it is not the complete list, ie some bandnames are missing:                            </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    
            <span class="c1">#make new dataframe for this object with zero flux and err values</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">singleoid</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
                <span class="n">zerosingle</span> <span class="o">=</span> <span class="n">make_zero_light_curve</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="c1">#keep track of these empty light curces in a list</span>
                <span class="n">zerosingle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zerosingle</span><span class="p">)</span>
    
    <span class="c1">#turn the empty light curves into a dataframe</span>
    <span class="n">df_empty</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">zerosingle_list</span><span class="p">)</span>
    <span class="c1"># df_empty has one row per dict. time,flux, and err columns store arrays.</span>
    <span class="c1"># &quot;explode&quot; the dataframe to get one row per light curve point. time, flux, and err columns will now store floats.</span>
    <span class="n">df_empty</span> <span class="o">=</span> <span class="n">df_empty</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;err&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_empty</span> <span class="o">=</span> <span class="n">df_empty</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">]})</span>


    <span class="c1">#now put the empty light curves back together with the main light curve dataframe</span>
    <span class="n">zeros_df_lc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">df_empty</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">zeros_df_lc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">missingdata_drop_bands</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">bands_to_keep</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop bands for which too many objects have no observations.</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>
<span class="sd">    bands_to_keep = list of strings with band names</span>
<span class="sd">        example: [&#39;W1&#39;,&#39;W2&#39;,&#39;panstarrs g&#39;,&#39;panstarrs i&#39;, &#39;panstarrs r&#39;,&#39;panstarrs y&#39;,&#39;panstarrs z&#39;,&#39;zg&#39;,&#39;zr&#39;]</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    clean_df: MultiIndexDFObject with light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># drop all rows where &#39;band&#39; is not in &#39;bands_to_keep&#39;</span>
    <span class="n">bands_to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">bands_to_keep</span><span class="p">)</span>
    <span class="n">clean_df</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bands_to_remove</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1">#how many objects did we start with?</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">objectid</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="s2">&quot;n objects before removing missing band data&quot;</span><span class="p">)</span>

    <span class="c1"># keep only objects with observations in all remaining bands</span>
    <span class="c1"># first, get a boolean series indexed by objectid</span>
    <span class="n">has_all_bands</span> <span class="o">=</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;objectid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">bands_to_keep</span><span class="p">))</span>
    <span class="c1"># extract the objectids that are &#39;True&#39;</span>
    <span class="n">objectids_to_keep</span> <span class="o">=</span> <span class="n">has_all_bands</span><span class="p">[</span><span class="n">has_all_bands</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="c1"># keep only these objects</span>
    <span class="n">clean_df</span> <span class="o">=</span> <span class="n">clean_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">clean_df</span><span class="o">.</span><span class="n">objectid</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">objectids_to_keep</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># How many objects are left?</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clean_df</span><span class="o">.</span><span class="n">objectid</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="s2">&quot;n objects after removing missing band data&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">clean_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#choose what to do with missing data...</span>
<span class="c1">#df_lc = missingdata_to_zeros(df_lc)</span>
<span class="c1">#or</span>
<span class="n">bands_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;W1&#39;</span><span class="p">,</span><span class="s1">&#39;W2&#39;</span><span class="p">,</span><span class="s1">&#39;panstarrs g&#39;</span><span class="p">,</span><span class="s1">&#39;panstarrs i&#39;</span><span class="p">,</span> <span class="s1">&#39;panstarrs r&#39;</span><span class="p">,</span><span class="s1">&#39;panstarrs y&#39;</span><span class="p">,</span><span class="s1">&#39;panstarrs z&#39;</span><span class="p">,</span><span class="s1">&#39;zg&#39;</span><span class="p">,</span><span class="s1">&#39;zr&#39;</span><span class="p">]</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">missingdata_drop_bands</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">bands_to_keep</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing">
<h3>2.6  Make all objects and bands have identical time arrays (uniform length and spacing)<a class="headerlink" href="#make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing" title="Link to this heading">#</a></h3>
<p>It is very hard to find time-domain ML algorithms which can work with non uniform length datasets. Therefore we make the light curves uniform by interpolating using KNN from scikit-learn which fills in the uniform length arrays with a final frequency chosen by the user.  We choose KNN as very straightforward method. This function also shows the framework in case the user wants to choose a different scikit-learn function to do the interpolation.  Another natural choice would be to use gaussian processes (GP) to do the interpolation, but this is not a good solution for our task because the flux values go to zero at times before and after the observations.  Because we include the entire time array from beginning of the first mission to end of the last mission, most individual bands require interpolation before and after their particular observations.  In other words, our light curves span the entire range from 2010 with the start of panstarrs and WISE to the most recent ZTF data release (at least 2023), even though most individual missions do not cover that full range of time.</p>
<p>It is important to choose the frequency over which the data is interpolated wisely.  Experimentation with treating this variable like a hyperparam and testing sktime algorithms shows slightly higher accuracy values for a suite of algorithms for a frequency of one interpolated observation per 60 days.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#what does the dataframe look like at this point in the code?</span>
<span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#this cell takes 13seconds to run on the sample of 458 sources</span>
<span class="k">def</span> <span class="nf">uniform_length_spacing</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">final_freq_interpol</span><span class="p">,</span> <span class="n">include_plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make all light curves have the same length and equal spacing</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    final_freq_interpol: int </span>
<span class="sd">        timescale of interpolation in units of days</span>
<span class="sd">        </span>
<span class="sd">    include_plot: bool</span>
<span class="sd">        will make an example plot of the interpolated light curve of a single object</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    df_interpol: MultiIndexDFObject with interpolated light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#make a time array with the minimum and maximum of all light curves in the sample</span>
    <span class="n">x_interpol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">final_freq_interpol</span><span class="p">)</span>
    <span class="n">x_interpol</span> <span class="o">=</span> <span class="n">x_interpol</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># needed for sklearn</span>
    <span class="n">lc_interpol</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list to store interpolated light curves</span>

    <span class="c1">#look at each object in each band</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">band</span><span class="p">,</span><span class="n">oid</span><span class="p">)</span> <span class="p">,</span> <span class="n">singleband_oid</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">]):</span>
        <span class="c1">#singleband_oid is now a dataframe with just one object and one band</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singleband_oid</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singleband_oid</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singleband_oid</span><span class="p">[</span><span class="s2">&quot;err&quot;</span><span class="p">])</span>

        <span class="c1">#could imagine using GP to make the arrays equal length and spacing</span>
        <span class="c1">#however this sends the flux values to zero at the beginning and end of </span>
        <span class="c1">#the arrays if there is time without observations.  This is not ideal</span>
        <span class="c1">#because it significantly changes the shape of the light curves.</span>
        
        <span class="c1">#kernel = 1.0 * RBF(length_scale=30)</span>
        <span class="c1">#gp = GaussianProcessRegressor(kernel=kernel, alpha=dy**2, normalize_y = False)</span>
        <span class="c1">#gp.fit(X, y)</span>
        <span class="c1">#mean_prediction,std_prediction = gp.predict(x_interpol, return_std=True)</span>

        <span class="c1">#try KNN</span>
        <span class="n">KNN</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">KNN</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">mean_prediction</span> <span class="o">=</span> <span class="n">KNN</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_interpol</span><span class="p">)</span>
        
        <span class="c1">#KNN doesnt output an uncertainty array, so make our own:</span>
        <span class="c1">#an array of the same length as mean_prediction</span>
        <span class="c1">#having values equal to the mean of the original uncertainty array</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">mean_prediction</span><span class="p">,</span> <span class="n">singleband_oid</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>  
        
        <span class="c1">#get these values into the dataframe</span>
        <span class="c1"># append the results as a dict. the list will be converted to a dataframe later.</span>
        <span class="n">lc_interpol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;objectid&quot;</span><span class="p">:</span> <span class="n">oid</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">singleband_oid</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">band</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">x_interpol</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
             <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="n">mean_prediction</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">}</span>
        <span class="p">)</span>
    
        <span class="k">if</span> <span class="n">include_plot</span><span class="p">:</span>
            <span class="c1">#see what this looks like on just a single light curve for now</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;zr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">oid</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">:</span>  
                <span class="c1">#see if this looks reasonable</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_interpol</span><span class="p">,</span> <span class="n">mean_prediction</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean prediction&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;flux&quot;</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;KNN regression&quot;</span><span class="p">)</span>
        
        
    <span class="c1"># create a dataframe of the interpolated light curves</span>
    <span class="n">df_interpol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lc_interpol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_interpol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#change this to change the frequency of the time array</span>
<span class="n">final_freq_interpol</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1">#this is the timescale of interpolation in units of days</span>

<span class="c1">#make all light curves have the same time array</span>
<span class="n">df_interpol</span> <span class="o">=</span> <span class="n">uniform_length_spacing</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">final_freq_interpol</span><span class="p">,</span> <span class="n">include_plot</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">)</span>

<span class="c1"># df_lc_interpol has one row per dict in lc_interpol. time and flux columns store arrays.</span>
<span class="c1"># &quot;explode&quot; the dataframe to get one row per light curve point. time and flux columns will now store floats.</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_interpol</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;err&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="restructure-dataframe">
<h3>2.7  Restructure dataframe<a class="headerlink" href="#restructure-dataframe" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Make columns have band names in them and then remove band from the index</p></li>
<li><p>pivot the dataframe so that SKTIME understands its format</p></li>
<li><p>this will put it in the format expected by sktime</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reformat_df</span><span class="p">(</span><span class="n">df_lc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformat dataframe into shape expected by sktime</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    res_df: MultiIndexDFObject with sktime appropriate shape</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
 
    <span class="c1">#keep some columns out of the mix when doing the pivot by bandname</span>
    <span class="c1">#set them as indices and they won&#39;t get pivoted into</span>
    <span class="n">reformat_df</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span>

    <span class="c1">#attach bandname to all the fluxes and uncertainties</span>
    <span class="n">reformat_df</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;band&quot;</span><span class="p">)</span>

    <span class="c1">#rename the columns</span>
    <span class="n">reformat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">reformat_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="c1">#many of these flux columns still have a space in them from the bandnames, </span>
    <span class="c1">#convert that space to underscore</span>
    <span class="n">reformat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> 

    <span class="c1">#and get rid of that index to cleanup</span>
    <span class="n">reformat_df</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  

    <span class="k">return</span> <span class="n">reformat_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#reformat the data to have columns be the different flux bands</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="p">(</span><span class="n">df_lc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#look at a single object to see what this array looks like</span>
<span class="n">ob_of_interest</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">singleob</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;objectid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ob_of_interest</span><span class="p">]</span>
<span class="n">singleob</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="normalize">
<h3>2.8 Normalize<a class="headerlink" href="#normalize" title="Link to this heading">#</a></h3>
<p>Normalizing is required so that the CLAGN and it’s comparison SDSS sample don’t have different flux levels.  ML algorithms will easily choose to classify based on overall flux levels, so we want to prevent that by normalizing the fluxes. Normalization with a multiband dataset requires extra thought.  The idea here is that we normalize across each object.  We want the algorithms to know, for example, that within one object W1 will be brighter than ZTF bands but from one object to the next, it will not know that one is brighter than the other.</p>
<p>We do the normalization at this point in the code, rather than before interpolating over time, so that the final light curves are normalized since that is the chunk of information which goes into the ML algorithms.</p>
<p>We chose to normalize by the maximum flux in one band, and not median or mean because there are some objects where the median flux = 0.0 if we did a replacement by zeros for missing data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">local_normalization_max</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">norm_column</span> <span class="o">=</span> <span class="s2">&quot;flux_W1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    normalize each individual light curve by the max value in one band</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    norm_column: str</span>
<span class="sd">        name of the flux column in df_lc by which the light curves should be normalized</span>
<span class="sd">        ie., which band should be the normalizing band?</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    df_lc: MultiIndexDFObject with interpolated light curves</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#make a copy to not alter the original df_lc inside of this function</span>
    <span class="n">norm_df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># make a new column with max_r_flux for each objectid</span>
    <span class="n">max_W1</span> <span class="o">=</span> <span class="n">norm_df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;objectid&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="n">norm_column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>

    <span class="c1">#figure out which columns in the dataframe are flux columns</span>
    <span class="n">flux_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">norm_df_lc</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;flux&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>

    <span class="c1"># make new normalized flux columns for all fluxes</span>
    <span class="n">norm_df_lc</span><span class="p">[</span><span class="n">flux_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_df_lc</span><span class="p">[</span><span class="n">flux_cols</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">max_W1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm_df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#normalize by W1 band</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">local_normalization_max</span><span class="p">(</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">norm_column</span> <span class="o">=</span> <span class="s2">&quot;flux_W1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="cleanup">
<h3>2.9 Cleanup<a class="headerlink" href="#cleanup" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Make <a class="reference external" href="https://docs.python.org/3/library/datetime.html#module-datetime">datetime</a> column</p>
<ul>
<li><p>SKTime wants a datetime column</p></li>
</ul>
</li>
<li><p>Save dataframe</p></li>
<li><p>Make into multi-index
- SKtime wants multi-index</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mjd_to_datetime</span><span class="p">(</span><span class="n">df_lc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    convert time column in dataframe into datetime</span>
<span class="sd">       </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_lc: Pandas dataframe with light curve info</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    t.datetime: array of type datetime</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#need to convert df_lc time into datetime</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">time</span>

    <span class="c1">#convert to JD</span>
    <span class="n">jd</span> <span class="o">=</span> <span class="n">mjd_to_jd</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>

    <span class="c1">#convert to individual components</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span> <span class="p">)</span>

    <span class="c1">#t.datetime is now an array of type datetime</span>
    <span class="c1">#make it a column in the dataframe</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">datetime</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># need to make a datetime column</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mjd_to_datetime</span><span class="p">(</span><span class="n">df_lc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#save this dataframe to use for the ML below so we don&#39;t have to make it every time</span>
<span class="n">parquet_savename</span> <span class="o">=</span> <span class="s1">&#39;output/df_lc_ML.parquet&#39;</span>
<span class="c1">#df_lc.to_parquet(parquet_savename)</span>
<span class="c1">#print(&quot;file saved!&quot;)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="prep-for-ml-algorithms">
<h2>3. Prep for ML algorithms<a class="headerlink" href="#prep-for-ml-algorithms" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># could load a previously saved file in order to plot</span>
<span class="c1">#parquet_loadname = &#39;output/df_lc_ML.parquet&#39;</span>
<span class="c1">#df_lc = MultiIndexDFObject()</span>
<span class="c1">#df_lc.data = pd.read_parquet(parquet_loadname)</span>
<span class="c1">#print(&quot;file loaded!&quot;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#try dropping the uncertainty columns as variables for sktime</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;err_panstarrs_g&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_panstarrs_i&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_panstarrs_r&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_panstarrs_y&#39;</span><span class="p">,</span>	
                      <span class="s1">&#39;err_panstarrs_z&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_W1&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_W2&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_zg&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_zr&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1">#drop also the time column because time shouldn&#39;t be a feature</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="train-test-split">
<h3>3.1 Train test split<a class="headerlink" href="#train-test-split" title="Link to this heading">#</a></h3>
<p>We use sklearn’s train test split to randomly split the data into training and testing datasets.  Because thre are uneven numbers of each type (many more SDSS than CLAGN), we want to make sure to stratify evenly by type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#divide the dataframe into features and labels for ML algorithms </span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[[</span><span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1">#want a stratified split based on label</span>
<span class="n">train_ix</span><span class="p">,</span> <span class="n">test_ix</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stratify</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">43</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span><span class="p">)</span>

<span class="c1">#X is defined to be the features</span>
<span class="c1">#y is defined to be the labels</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_ix</span><span class="p">]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_ix</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_ix</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_ix</span><span class="p">]</span>

<span class="c1">#plot to show how many of each type of object in the test dataset</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Objects in the Test dataset&quot;</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="run-sktime-algorithms-on-the-light-curves">
<h2>4. Run sktime algorithms on the light curves<a class="headerlink" href="#run-sktime-algorithms-on-the-light-curves" title="Link to this heading">#</a></h2>
<p>We choose to use <a class="reference external" href="https://www.sktime.net/en/stable/index.html">sktime</a> algorithms beacuse it is a library of many algorithms specifically tailored to time series datasets.  It is based on the sklearn library so syntax is familiar to many users.</p>
<p>Types of classifiers are listed <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/classification.html">here</a>.</p>
<p>This notebook will first show you an example of a single algorithm classifier. Then it will show how to write a for loop over a bunch of classifiers while outputting some metrics of accuracy.</p>
<section id="check-that-the-data-types-are-ok-for-sktime">
<h3>4.1 Check that the data types are ok for sktime<a class="headerlink" href="#check-that-the-data-types-are-ok-for-sktime" title="Link to this heading">#</a></h3>
<p>This test needs to pass in order for sktime to run</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#ask sktime if it likes the data type of X_train</span>
<span class="c1">#if you change any of the functions or cells above this one, it is a good idea to </span>
<span class="c1"># look at the below output to make sure you haven&#39;t introduced any NaNs or unequal length series</span>
<span class="n">check_is_mtype</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="s2">&quot;pd-multiindex&quot;</span><span class="p">,</span> <span class="n">scitype</span><span class="o">=</span><span class="s2">&quot;Panel&quot;</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#show the list of all possible classifiers that work with multivariate data</span>
<span class="c1">#all_tags(estimator_types = &#39;classifier&#39;)</span>
<span class="c1">#classifiers = all_estimators(&quot;classifier&quot;, filter_tags={&#39;capability:multivariate&#39;:True})</span>
<span class="c1">#classifiers</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-single-classifier">
<h3>4.1 A single Classifier<a class="headerlink" href="#a-single-classifier" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>

<span class="c1">#setup the classifier</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">Arsenal</span><span class="p">(</span><span class="n">time_limit_in_minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#fit the classifier on the training dataset</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1">#make predictions on the test dataset using the trained model </span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy of Random Interval Classifier: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#plot a confusion matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="n">disp</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span><span class="n">display_labels</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="n">disp</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loop-over-a-bunch-of-classifiers">
<h3>4.2 Loop over a bunch of classifiers<a class="headerlink" href="#loop-over-a-bunch-of-classifiers" title="Link to this heading">#</a></h3>
<p>Our method is to do a cursory check of a bunch of classifiers and then later drill down deeper on anything with good initial results.  We choose to run a loop over ~10 classifiers that seem promising and check the accuracy scores for each one.  Any classifier with a promising accuracy score could then be followed up with detailed hyperparameter tuning, or potentially with considering other classifiers in that same type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#save statistics from these runs</span>

<span class="c1"># Serialize data into file:</span>
<span class="c1">#json.dump( accscore_dict, open( &quot;output/accscore.json&quot;, &#39;w&#39; ) )</span>
<span class="c1">#json.dump( completeness_dict, open( &quot;output/completeness.json&quot;, &#39;w&#39; ) )</span>
<span class="c1">#json.dump( homogeneity_dict, open( &quot;output/homogeneity.json&quot;, &#39;w&#39; ) )</span>

<span class="c1"># Read data from file:</span>
<span class="c1">#accscore_dict = json.load( open( &quot;output/accscore.json&quot;) )</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="create-a-candidate-list">
<h2>5.0 Create a candidate list<a class="headerlink" href="#create-a-candidate-list" title="Link to this heading">#</a></h2>
<p>Lets assume we now have a classifier which can accurately differentiate CLAGN from SDSS QSOs based on their archival light curves.  Next, we would like to use that classifier on our favorite unlabeled sample to identify CLAGN candidates.  To do this, we need to:</p>
<ul class="simple">
<li><p>read in a dataframe of our new sample</p></li>
<li><p>get that dataset in the same format as what was fed into the classifiers</p></li>
<li><p>use your trained classifier to predict labels for the new sample</p></li>
<li><p>retrace those objectids to an ra &amp; dec</p></li>
<li><p>write an observing proposal (ok, you have to do that one yourself)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#read in a dataframe of our new sample:</span>
<span class="c1"># we are going to cheat here and use the same file as we used for input to the above, but you should</span>
<span class="c1"># replace this with your favorite sample run through the light_curve_generator in this same repo.</span>
<span class="n">path_to_sample</span> <span class="o">=</span> <span class="s1">&#39;./data/small_CLAGN_SDSS_df_lc.parquet&#39;</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">path_to_sample</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#get dataset in same format as what was run through sktime</span>
<span class="c1">#This is not exactly the same as re-running the whole notebook on a different sample,</span>
<span class="c1">#but it is pretty close.  We don&#39;t need to do all of the same cleaning because some of that </span>
<span class="c1">#was to appease sktime in training the algorithms.</span>

    

<span class="c1">#get rid of indices set in the light curve code and reset them as needed before sktime algorithms</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">my_sample</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  

<span class="c1"># get rid of some of the bands that don&#39;t have enough data for all the sources</span>
<span class="c1">#CLAGN are generall fainter targets, and therefore mostly not found in datasets like TESS &amp; K2</span>
<span class="c1">#make sure your sample has the same bands as were run to train the classifier</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">my_sample</span><span class="p">[</span><span class="o">~</span><span class="n">my_sample</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bands_to_drop</span><span class="p">)]</span>

<span class="c1">#drop rows which have Nans</span>
<span class="n">my_sample</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#remove outliers</span>
<span class="c1">#make sure your sample has the same sigmaclip_value as was run to train the classifier</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">sigmaclip_lightcurves</span><span class="p">(</span><span class="n">my_sample</span><span class="p">,</span> <span class="n">sigmaclip_value</span><span class="p">,</span> <span class="n">include_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1">#remove objects without W1 fluxes</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">remove_objects_without_band</span><span class="p">(</span><span class="n">my_sample</span><span class="p">,</span> <span class="s1">&#39;W1&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">#remove incomplete data</span>
<span class="c1">#make sure your sample has the same threshold_too_few as were run to train the classifier</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">remove_incomplete_data</span><span class="p">(</span><span class="n">my_sample</span><span class="p">,</span> <span class="n">threshold_too_few</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1">#drop missing bands</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">missingdata_drop_bands</span><span class="p">(</span><span class="n">my_sample</span><span class="p">,</span> <span class="n">bands_to_keep</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1">#make arrays have uniform length and spacing</span>
<span class="c1">#make sure your sample has the same final_feq_interpol as was run to train the classifier</span>
<span class="n">df_interpol</span> <span class="o">=</span> <span class="n">uniform_length_spacing</span><span class="p">(</span><span class="n">my_sample</span><span class="p">,</span> <span class="n">final_freq_interpol</span><span class="p">,</span> <span class="n">include_plot</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">)</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">df_interpol</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;err&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">my_sample</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">]})</span>

<span class="c1">#reformat the data to have columns be the different flux bands</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="p">(</span><span class="n">my_sample</span><span class="p">)</span>

<span class="c1">#normalize</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">local_normalization_max</span><span class="p">(</span><span class="n">my_sample</span><span class="p">,</span> <span class="n">norm_column</span> <span class="o">=</span> <span class="s2">&quot;flux_W1&quot;</span><span class="p">)</span>

<span class="c1">#make datetime column</span>
<span class="n">my_sample</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mjd_to_datetime</span><span class="p">(</span><span class="n">my_sample</span><span class="p">)</span>

<span class="c1">#set index expected by sktime</span>
<span class="n">my_sample</span> <span class="o">=</span> <span class="n">my_sample</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>

<span class="c1">#drop the uncertainty and time columns </span>
<span class="n">my_sample</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;err_panstarrs_g&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_panstarrs_i&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_panstarrs_r&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_panstarrs_y&#39;</span><span class="p">,</span>	
                          <span class="s1">&#39;err_panstarrs_z&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_W1&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_W2&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_zg&#39;</span><span class="p">,</span>	<span class="s1">&#39;err_zr&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

 <span class="c1">#make X </span>
<span class="n">X_mysample</span>  <span class="o">=</span> <span class="n">my_sample</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#what does this look like to make sure we are on track</span>
<span class="n">X_mysample</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#use the trained sktime algorithm to make predictions on the test dataset</span>
<span class="n">y_mysample</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_mysample</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#access the sample_table made in the light curve generator notebook</span>
<span class="c1">#has information about the sample including ra &amp; dec </span>
<span class="n">savename_sample</span> <span class="o">=</span> <span class="s1">&#39;./data/small_CLAGN_SDSS_sample.ecsv&#39;</span>
<span class="n">gdd</span><span class="o">.</span><span class="n">download_file_from_google_drive</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="s1">&#39;1pSEKVP4LbrdWQK9ws3CaI90m3Z_2fazL&#39;</span><span class="p">,</span>
                                    <span class="n">dest_path</span><span class="o">=</span><span class="n">savename_sample</span><span class="p">,</span>
                                    <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sample_table</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">savename_sample</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii.ecsv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#associate these predicted CLAGN with RA &amp; Dec</span>

<span class="c1">#need to first associate objectid with each of y_mysample</span>
<span class="c1">#make a new df with a column = objectid which </span>
<span class="c1">#includes all the unique objectids.</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">X_mysample</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">mysample_CLAGN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">objectid</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;objectid&#39;</span><span class="p">])</span>
<span class="n">mysample_CLAGN</span><span class="p">[</span><span class="s2">&quot;predicted_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_mysample</span><span class="p">)</span>

<span class="c1">#if I am only interested in the CLAGN, could drop anything with label = SDSS</span>
<span class="n">querystring</span> <span class="o">=</span> <span class="s1">&#39;predicted_label == &quot;SDSS&quot;&#39;</span>
<span class="n">mysample_CLAGN</span> <span class="o">=</span> <span class="n">mysample_CLAGN</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">mysample_CLAGN</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring</span> <span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1">#then will need to merge candidate_CLAGN with sample_table along objectid</span>
<span class="n">sample_table_df</span> <span class="o">=</span> <span class="n">sample_table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="n">candidate_CLAGN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mysample_CLAGN</span><span class="p">,</span> <span class="n">sample_table_df</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#show the CLAGN candidates ra &amp; dec</span>
<span class="n">candidate_CLAGN</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Link to this heading">#</a></h2>
<p>Depending on your comfort level with the accuracy of the classifier you have trained, you could now write an observing proposal to confirm those targets prediced to be CLAGN based on their multiwavelength light curves.</p>
</section>
<section id="references">
<h2>References:<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>“sktime: A Unified Interface for Machine Learning with Time Series”
Markus Löning, Tony Bagnall, Sajaysurya Ganesh, George Oastler, Jason Lines, ViktorKaz, …, Aadesh Deshmukh (2020). sktime/sktime. Zenodo. http://doi.org/10.5281/zenodo.3749000</p></li>
<li><p>“Scikit-learn: Machine Learning in Python”, Pedregosa et al., JMLR 12, pp. 2825-2830, 2011.</p></li>
<li><p>“pandas-dev/pandas: Pandas” The pandas development team, 2020. Zenodo. https://doi.org/10.5281/zenodo.3509134</p></li>
<li><p>This work made use of <a class="reference external" href="http://www.astropy.org">Astropy</a> a community-developed core Python package and an ecosystem of tools and resources for astronomy (astropy:2013, astropy:2018, astropy:2022).</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-a-dataset-of-archival-light-curves">1. Read in a dataset of archival light curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-prep">2. Data Prep</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-bands-with-not-enough-data">2.1 Remove bands with not enough data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-labels-for-a-simpler-classification">2.2 Combine Labels for a Simpler Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-visualization">2.3 Data Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clean-the-dataset-of-unwanted-data">2.4 Clean the dataset of unwanted data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-data">2.5 Missing Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing">2.6  Make all objects and bands have identical time arrays (uniform length and spacing)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restructure-dataframe">2.7  Restructure dataframe</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize">2.8 Normalize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleanup">2.9 Cleanup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prep-for-ml-algorithms">3. Prep for ML algorithms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split">3.1 Train test split</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-sktime-algorithms-on-the-light-curves">4. Run sktime algorithms on the light curves</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-that-the-data-types-are-ok-for-sktime">4.1 Check that the data types are ok for sktime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-single-classifier">4.1 A single Classifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-a-bunch-of-classifiers">4.2 Loop over a bunch of classifiers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-candidate-list">5.0 Create a candidate list</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References:</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Fornax developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2023, Fornax developers.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>