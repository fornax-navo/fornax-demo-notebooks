
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Light Curve Classifier &#8212; Fornax Demo Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'light_curves/lc_classifier';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Make Multiwavelength Light Curves Using Archival Data" href="light_curve_generator.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/fornax_logo.png" class="logo__image only-light" alt="Fornax Demo Notebooks - Home"/>
    <script>document.write(`<img src="../_static/fornax_logo.png" class="logo__image only-dark" alt="Fornax Demo Notebooks - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/fornax-navo/fornax-demo-notebooks" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Table of Content
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../forced_photometry/README.html">Multi-band forced photometry</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../forced_photometry/multiband_photometry.html">Automated Multiband Forced Photometry on Large Datasets</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="README.html">Time Domain</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="light_curve_generator.html">Make Multiwavelength Light Curves Using Archival Data</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Light Curve Classifier</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/fornax-navo/fornax-demo-notebooks/main?urlpath=tree/light_curves/lc_classifier.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/fornax-navo/fornax-demo-notebooks/blob/main/light_curves/lc_classifier.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/fornax-navo/fornax-demo-notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fornax-navo/fornax-demo-notebooks/edit/main/light_curves/lc_classifier.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/fornax-navo/fornax-demo-notebooks/issues/new?title=Issue%20on%20page%20%2Flight_curves/lc_classifier.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/light_curves/lc_classifier.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../_sources/light_curves/lc_classifier.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Light Curve Classifier</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-a-dataset-of-archival-light-curves">1. Read in a dataset of archival light curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-prep">2. Data Prep</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-bands-with-not-enough-data">2.1 Remove bands with not enough data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-labels-for-a-simpler-classification">2.2 Combine Labels for a Simpler Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-bad-data">2.3 Remove “bad”  data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incomplete-data">2.4 Incomplete Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-data">2.5 Missing Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing">2.5  Make all objects and bands have identical time arrays (uniform length and spacing)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restructure-dataframe-in-format-expected-by-sktime">2.6  Restructure dataframe in format expected by sktime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize">2.7 Normalize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-datetime-time-column">2.8 Make datetime time column</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-this-dataframe">2.9 Save this dataframe</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-into-multi-index-which-is-what-sktime-expects-as-input">2.10 make into multi-index which is what SKTime expects as input</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prep-for-ml-algorithms-in-sktime">3. Prep for ML algorithms in sktime</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consider-data-augmentation">3.0 Consider data augmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split">3.1 Train test split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-that-the-data-types-are-ok-for-sktime">3.2 Check that the data types are ok for sktime</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-machine-learning-algorithms-on-the-light-curves">4. Run Machine Learning Algorithms on the light curves</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-most-accurate-classifier">4.1 The Most Accurate Classifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-a-bunch-of-classifiers">4.2 Loop over a bunch of classifiers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">5.0 Conclusions:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#potential-areas-of-improvement">5.1 Potential Areas of improvement</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="light-curve-classifier">
<h1>Light Curve Classifier<a class="headerlink" href="#light-curve-classifier" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<section id="learning-goals">
<h2>Learning Goals<a class="headerlink" href="#learning-goals" title="Link to this heading">#</a></h2>
<p>By the end of this tutorial, you will be able to:</p>
<ul class="simple">
<li><p>do some basic data cleaning and filtering to prepare the data for the ML algorithms</p></li>
<li><p>work with Pandas data frames as a way of storing time domain datasets</p></li>
<li><p>use sktime algorithms to train a classifier and predict values on a test dataset</p></li>
</ul>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This notebook takes output of a previous demo notebook which generates light curves from archival data, does data prep, and runs the light curves through multiple <a class="reference external" href="https://www.sktime.net/en/stable/"><code class="docutils literal notranslate"><span class="pre">sktime</span></code></a> classifiers.  The goal of the classifiers is to be able to differentiate changing look active galactic nucleii (CLAGN) from an SDSS quasar sample based on multiband light curves.  CLAGN are quite interested objects in that they appear to change state, but only a few hundred are currently known, and finding them is quite expensive requiring spectroscopic follow up.  Being able to identify CLAGN in existing large samples would allow us to identify a statisitcal sample from which we could better understand the physics of what is occuring in these systems.</p>
<p>The challenges of this time-domain dataset are:</p>
<ol class="arabic simple">
<li><p>Multi-variate = There are multiple bands of observations per target (13+)</p></li>
<li><p>Unequal length = Each band has a light curve with different sampling than other bands</p></li>
<li><p>Missing data = Not each object has all observations in all bands</p></li>
</ol>
<p>We choose to use a Pandas multiindex dataframe to store and work with the data because it fulfills these requirements:</p>
<ol class="arabic simple">
<li><p>It can handle the above challenges of a dataset = multi-variate, unqueal length with missing data.</p></li>
<li><p>Multiple targets (multiple rows)</p></li>
<li><p>Pandas has some built in understanding of time units</p></li>
<li><p>Can be scaled up to big data numbers of rows (altough we don’t push to out of memory structures in this use case)</p></li>
<li><p>Pandas is user friendly</p></li>
</ol>
</section>
<section id="input">
<h2>Input<a class="headerlink" href="#input" title="Link to this heading">#</a></h2>
<p>Light curve parquet file of multiband light curves from the mulitband_lc.ipynb demo notebook.  The format of the light curves is a Pandas multiindex data frame</p>
<p>A useful reference for what sktime expects as input to its ML algorithms: https://github.com/sktime/sktime/blob/main/examples/AA_datatypes_and_datasets.ipynb</p>
</section>
<section id="output">
<h2>Output<a class="headerlink" href="#output" title="Link to this heading">#</a></h2>
<p>Trained classifiers as well as estimates of their accuracy and plots of confusion matrices</p>
</section>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pandas</span></code> to work with light curve data structure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numpy</span></code> for numerical calculations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> for plotting</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sys</span></code> for paths</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">astropy</span></code> to work with coordinates/units and data structures</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tqdm</span></code> for showing progress meter</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sktime</span></code> ML algorithms specifically for time-domain data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sklearn</span></code> general use ML algorthims with easy to use interface</p></li>
</ul>
</section>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h2>
</section>
<section id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#ensure all dependencies are installed</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">-</span><span class="n">lc_classifier</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">google_drive_downloader</span> <span class="kn">import</span> <span class="n">GoogleDriveDownloader</span> <span class="k">as</span> <span class="n">gdd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">sigmaclip</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">RBF</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>

<span class="kn">from</span> <span class="nn">sktime.classification.deep_learning</span> <span class="kn">import</span> <span class="n">CNNClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.dictionary_based</span> <span class="kn">import</span> <span class="n">IndividualTDE</span>
<span class="kn">from</span> <span class="nn">sktime.classification.distance_based</span> <span class="kn">import</span> <span class="n">KNeighborsTimeSeriesClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.ensemble</span> <span class="kn">import</span> <span class="n">WeightedEnsembleClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.feature_based</span> <span class="kn">import</span> <span class="n">Catch22Classifier</span><span class="p">,</span> <span class="n">RandomIntervalClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.hybrid</span> <span class="kn">import</span> <span class="n">HIVECOTEV2</span>
<span class="kn">from</span> <span class="nn">sktime.classification.interval_based</span> <span class="kn">import</span> <span class="n">CanonicalIntervalForest</span>
<span class="kn">from</span> <span class="nn">sktime.classification.kernel_based</span> <span class="kn">import</span> <span class="n">Arsenal</span><span class="p">,</span> <span class="n">RocketClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.classification.shapelet_based</span> <span class="kn">import</span> <span class="n">ShapeletTransformClassifier</span>
<span class="kn">from</span> <span class="nn">sktime.registry</span> <span class="kn">import</span> <span class="n">all_estimators</span><span class="p">,</span> <span class="n">all_tags</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># local code imports</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;code_src/&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">fluxconversions</span> <span class="kn">import</span> <span class="n">mjd_to_jd</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-a-dataset-of-archival-light-curves">
<h2>1. Read in a dataset of archival light curves<a class="headerlink" href="#read-in-a-dataset-of-archival-light-curves" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#access structure of light curves made in the light curve notebook</span>
<span class="c1"># has CLAGN &amp; SDSS small sample, all bands</span>
<span class="c1">#https://drive.google.com/file/d/13RiPODiz2kI8j1OKpP1vfh6ByIUNsKEz/view?usp=share_link</span>

<span class="n">gdd</span><span class="o">.</span><span class="n">download_file_from_google_drive</span><span class="p">(</span><span class="n">file_id</span><span class="o">=</span><span class="s1">&#39;13RiPODiz2kI8j1OKpP1vfh6ByIUNsKEz&#39;</span><span class="p">,</span>
                                    <span class="n">dest_path</span><span class="o">=</span><span class="s1">&#39;./data/df_lc_458sample.parquet&#39;</span><span class="p">,</span>
                                    <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df_lc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;./data/df_lc_458sample.parquet&quot;</span><span class="p">)</span>

<span class="c1">#get rid of indices set in the light curve code and reset them as needed before sktime algorithms</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-prep">
<h2>2. Data Prep<a class="headerlink" href="#data-prep" title="Link to this heading">#</a></h2>
<p>This dataset needs significant work before it can be fed into a ML algorithm</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#what does the dataset look like anyway?</span>
<span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
<section id="remove-bands-with-not-enough-data">
<h3>2.1 Remove bands with not enough data<a class="headerlink" href="#remove-bands-with-not-enough-data" title="Link to this heading">#</a></h3>
<p>For this use case of CLAGN classification, we don’t need to include some of the bands
that are known to be sparse.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">##what are the unique set of bands included in our light curves</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get rid of some of the bands that don&#39;t have enough data for all the sources</span>

<span class="n">bands_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;IceCube&quot;</span><span class="p">,</span> <span class="s2">&quot;TESS&quot;</span><span class="p">,</span> <span class="s2">&quot;FERMIGTRIG&quot;</span><span class="p">,</span> <span class="s2">&quot;K2&quot;</span><span class="p">]</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span><span class="o">~</span><span class="n">df_lc</span><span class="p">[</span><span class="s2">&quot;band&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bands_to_drop</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="combine-labels-for-a-simpler-classification">
<h3>2.2 Combine Labels for a Simpler Classification<a class="headerlink" href="#combine-labels-for-a-simpler-classification" title="Link to this heading">#</a></h3>
<p>All CLAGN start in the dataset as having labels based on their discovery paper.  Because we want one sample with all known CLAGN, change those discoery names to be simply “CLAGN” for all CLAGN, regardless of origin</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MacLeod 16&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;LaMassa 15&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Yang 18&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Lyu 21&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hon 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Sheng 20&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MacLeod 19&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Green 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Lopez-Navas 22&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAGN&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="remove-bad-data">
<h3>2.3 Remove “bad”  data<a class="headerlink" href="#remove-bad-data" title="Link to this heading">#</a></h3>
<p>“bad” includes:</p>
<ul class="simple">
<li><p>errant values</p></li>
<li><p>NaNs</p></li>
<li><p>zero flux</p></li>
<li><p>outliers in uncertainty</p></li>
<li><p>objects with not enough flux measurements to make a good light curve</p></li>
<li><p>objects with no measurements in WISE W1 band</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#find and drop bad rows</span>

<span class="c1">#one panstarrs z has a crazy err value of -999000, definitely don&#39;t want to include that one</span>
<span class="n">querystring</span> <span class="o">=</span> <span class="s1">&#39;err &lt; -100&#39;</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1">#drop rows which have Nans</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">#drop ~8 rows with zero flux</span>
<span class="c1">#We are going to define zero flux later to be missing data, but not sure what these are</span>
<span class="n">querystring</span> <span class="o">=</span> <span class="s1">&#39;flux &lt; 0.000001&#39;</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#consider Removing all rows with uncertainties well outside of a normal distribution</span>
<span class="c1">#plot histograms to see what these distributions look like</span>
<span class="c1">#This is a tricky job because we want to keep astrophysical outliers of variable objects, but </span>
<span class="c1">#remove instrumental noise and CR (ground based)</span>

<span class="c1">#keep track of how many rows this removes</span>
<span class="n">start_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_lc</span><span class="p">)</span>

<span class="c1">#setup to collect the outlier thresholds per band to later reject</span>
<span class="n">nsigmaonmean</span><span class="o">=</span> <span class="p">{}</span>

<span class="c1">#what value of sigma are we going to consider is an outlier?</span>
<span class="n">sigmaclip_value</span> <span class="o">=</span> <span class="mf">10.0</span>

<span class="c1">#create the figure and axes</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># unpack all the axes subplots</span>
<span class="n">axe</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1">#for each band</span>
<span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">bandname</span><span class="p">,</span> <span class="n">singleband</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;band&quot;</span><span class="p">)):</span>
    
    <span class="c1">#use scipy sigmaclip to iteratively determine sigma on the dataset</span>
    <span class="n">clippedarr</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">sigmaclip</span><span class="p">(</span><span class="n">singleband</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="n">sigmaclip_value</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">sigmaclip_value</span><span class="p">)</span>
    
    <span class="c1">#store this value for later</span>
    <span class="n">nsigmaonmean</span><span class="p">[</span><span class="n">bandname</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper</span>
    
    <span class="c1">#plot distributions and print stddev</span>
    <span class="n">singleband</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">subplots</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axe</span><span class="p">[</span><span class="n">count</span><span class="p">],</span><span class="n">label</span> <span class="o">=</span> <span class="n">bandname</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">upper</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#remove data that are outside the sigmaclip_value</span>
<span class="k">for</span> <span class="n">bandname</span><span class="p">,</span> <span class="n">cut</span> <span class="ow">in</span> <span class="n">nsigmaonmean</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">querystring</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;band == </span><span class="si">{</span><span class="n">bandname</span><span class="si">!r}</span><span class="s1"> &amp; err &gt; </span><span class="si">{</span><span class="n">cut</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#how much data did we remove with this sigma clipping?</span>
<span class="c1">#This should inform our choice of sigmaclip_value.</span>

<span class="n">end_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_lc</span><span class="p">)</span>
<span class="n">fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_len</span> <span class="o">-</span> <span class="n">end_len</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_len</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This </span><span class="si">{</span><span class="n">sigmaclip_value</span><span class="si">}</span><span class="s2"> sigma clipping removed </span><span class="si">{</span><span class="n">fraction</span><span class="si">}</span><span class="s2">% of the rows in df_lc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Remove objects which do not have fluxes measured in the band with which we want to normalize</span>
<span class="c1">#which band has the most data?</span>

<span class="c1">#Later in the code we will need to noramalize fluxes by one of the bands</span>
<span class="c1">#This cell aims to figure out which band has the most data </span>
<span class="c1">#this needs to be run before we go and fill in missing data</span>

<span class="c1">#how many objects are there total?</span>
<span class="n">total_objectids</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="s2">&quot;objectid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ngroups</span>

<span class="c1">#how many objects have at least 1 flux in each of the band?</span>
<span class="k">for</span> <span class="n">band</span><span class="p">,</span> <span class="n">df_lc_band</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="s2">&quot;band&quot;</span><span class="p">):</span>
    <span class="n">total_band</span> <span class="o">=</span> <span class="n">df_lc_band</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ngroups</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total_band</span><span class="o">/</span><span class="n">total_objectids</span><span class="p">,</span> <span class="s2">&quot; have &quot;</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="s2">&quot; fluxes&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#this argues for normalizing by w1 fluxes (later)</span>
<span class="c1">#We will therefore need to get rid of the 4% of light curves which do not have W1 data</span>
<span class="c1">#as there will be nothing to normalize those light curves with and we don&#39;t want to </span>
<span class="c1">#have un-normalized data or data that has been normalized by a different band.  </span>

<span class="c1">#keep track of how many get dropped</span>
<span class="n">dropcount</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">#for each object</span>
<span class="k">for</span> <span class="n">oid</span> <span class="p">,</span> <span class="n">singleoid</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">):</span>
    <span class="c1">#what bands does that object have</span>
    <span class="n">bandname</span> <span class="o">=</span> <span class="n">singleoid</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="c1">#if it doesn&#39;t have W1:</span>
    <span class="k">if</span> <span class="s1">&#39;w1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bandname</span><span class="p">:</span>
        <span class="c1">#delete this oid from the dataframe of light curves</span>
        <span class="n">indexoid</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span> <span class="p">(</span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;objectid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">oid</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df_lc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">indexoid</span> <span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1">#keep track of how many are being deleted</span>
        <span class="n">dropcount</span> <span class="o">=</span> <span class="n">dropcount</span> <span class="o">+</span> <span class="mi">1</span>
        
        
<span class="nb">print</span><span class="p">(</span> <span class="n">dropcount</span><span class="p">,</span> <span class="s2">&quot;objects do not have W1 fluxes and were removed&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="incomplete-data">
<h3>2.4 Incomplete Data<a class="headerlink" href="#incomplete-data" title="Link to this heading">#</a></h3>
<p>Some objects have only a few datapoints.  Three data points is not large enough for KNN interpolation, so we will consider any array with fewer than 4 photometry points to be incomplete data.</p>
<p>Another way of saying this is that we choose to remove those light curves with 3 or fewer data points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Define what the threshold is for too few datapoints.</span>
<span class="n">thresh_too_few</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1">#how many groups do we have before we start</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n groups before&quot;</span><span class="p">)</span>

<span class="c1">#use pandas .filter to remove small groups</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh_too_few</span><span class="p">)</span>

<span class="c1">#how many groups do we have after culling?</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ngroups</span><span class="p">,</span> <span class="s2">&quot;n groups after&quot;</span><span class="p">)</span>

<span class="c1">#currently this seems like a lot of groups because we still have the gaia single photometry points for many objects</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="missing-data">
<h3>2.5 Missing Data<a class="headerlink" href="#missing-data" title="Link to this heading">#</a></h3>
<p>Some objects do not have light curves in all bands.  Some ML algorithms can handle mising data, but not all, so it would be useful to handle this missing data up front.</p>
<p>We will add light curves with zero flux and err values for the missing data.  SKtime does not like NaNs, so we chose zeros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_zero_lc</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="c1">#randomly choose some times during the WISE survey</span>
    <span class="c1">#these will all get fleshed out in the section on making uniform length time arrays</span>
    <span class="c1">#so the specifics are not important now</span>
    <span class="n">timelist</span> <span class="o">=</span> <span class="p">[</span><span class="mf">55230.0</span><span class="p">,</span><span class="mf">57054.0</span><span class="p">,</span> <span class="mf">57247.0</span><span class="p">,</span> <span class="mf">57977.0</span><span class="p">,</span> <span class="mf">58707.0</span><span class="p">]</span>  
    
    <span class="c1">#make a dictionary to hold the light curve</span>
    <span class="n">zerosingle</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;objectid&quot;</span><span class="p">:</span> <span class="n">oid</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">band</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">timelist</span><span class="p">,</span> 
                  <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timelist</span><span class="p">)),</span> <span class="s2">&quot;err&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timelist</span><span class="p">))}</span>
    
    <span class="k">return</span> <span class="n">zerosingle</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#for the case where there is no photometry in a band:</span>
<span class="c1">#make light curves with flux, err set to zeros</span>

<span class="c1">#what is the full set of unique band names?</span>
<span class="n">full_bandname</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1">#setup a list to store empty light curves</span>
<span class="n">zerosingle_list</span> <span class="o">=</span> <span class="p">[]</span> 

<span class="c1">#for each object in each band</span>
<span class="k">for</span> <span class="n">oid</span> <span class="p">,</span> <span class="n">singleoid</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;objectid&quot;</span><span class="p">):</span>
                                  
    <span class="c1">#this is the list of bandnames for that object                                </span>
    <span class="n">oid_bandname</span> <span class="o">=</span> <span class="n">singleoid</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="c1">#figure out which bands are missing</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">full_bandname</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">oid_bandname</span><span class="p">))</span>
    
    <span class="c1">#if it is not the complete list, ie some bandnames are missing:                            </span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    
        <span class="c1">#make new dataframe for this object with zero flux and err values</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">singleoid</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
            <span class="n">zerosingle</span> <span class="o">=</span> <span class="n">make_zero_lc</span><span class="p">(</span><span class="n">oid</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="c1">#keep track of these empty light curces in a list</span>
            <span class="n">zerosingle_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zerosingle</span><span class="p">)</span>

            
<span class="c1">#turn the empty light curves into a dataframe</span>
<span class="n">df_empty</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">zerosingle_list</span><span class="p">)</span>
<span class="c1"># df_empty has one row per dict. time,flux, and err columns store arrays.</span>
<span class="c1"># &quot;explode&quot; the dataframe to get one row per light curve point. time, flux, and err columns will now store floats.</span>
<span class="n">df_empty</span> <span class="o">=</span> <span class="n">df_empty</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;err&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_empty</span> <span class="o">=</span> <span class="n">df_empty</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">]})</span>


<span class="c1">#now put the empty light curves back together with the main light curve dataframe</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_lc</span><span class="p">,</span> <span class="n">df_empty</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing">
<h3>2.5  Make all objects and bands have identical time arrays (uniform length and spacing)<a class="headerlink" href="#make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing" title="Link to this heading">#</a></h3>
<p>It is very hard to find time-domain ML algorithms which can handle non uniform length datasets. Therefore we make them uniform using Pandas <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.reindex.html">reindex</a> which fills in the uniform length arrays with values according to the method chosen by the user.  We implement a nearest neighbor to fill the arrays.</p>
<p>try a sklearn regressor to fit the shape of the light curve and do interpolation</p>
<p>Potential other options for uniformizing the time series dataset:</p>
<ul class="simple">
<li><p>pandas.dataframe.interpolate with many methods</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#what does it look like?</span>
<span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#this cell takes 13seconds to run on the sample of 458 sources</span>

<span class="c1">#change this to change the frequency of the time array</span>
<span class="n">final_freq_int</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1">#this is the timescale of interpolation in units of days</span>

<span class="c1">#make a time array with the minimum and maximum of all light curves in the sample</span>
<span class="n">x_interpol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">final_freq_int</span><span class="p">)</span>
<span class="n">x_interpol</span> <span class="o">=</span> <span class="n">x_interpol</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># needed for sklearn</span>
<span class="n">lc_interpol</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list to store interpolated light curves</span>

<span class="c1">#look at each object in each band</span>
<span class="k">for</span> <span class="p">(</span><span class="n">band</span><span class="p">,</span><span class="n">oid</span><span class="p">)</span> <span class="p">,</span> <span class="n">singleband_oid</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="s2">&quot;objectid&quot;</span><span class="p">]):</span>
    <span class="c1">#singleband_oid is now a dataframe with just one object and one band</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singleband_oid</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singleband_oid</span><span class="p">[</span><span class="s2">&quot;flux&quot;</span><span class="p">])</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">singleband_oid</span><span class="p">[</span><span class="s2">&quot;err&quot;</span><span class="p">])</span>
    
    <span class="c1">#kernel = 1.0 * RBF(length_scale=30)</span>
    <span class="c1">#gp = GaussianProcessRegressor(kernel=kernel, alpha=dy**2, normalize_y = False)</span>
    <span class="c1">#gp.fit(X, y)</span>
    <span class="c1">#mean_prediction,std_prediction = gp.predict(x_interpol, return_std=True)</span>

    <span class="c1">#try KNN</span>
    <span class="n">KNN</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">KNN</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mean_prediction</span> <span class="o">=</span> <span class="n">KNN</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_interpol</span><span class="p">)</span>
        
    <span class="c1">#KNN doesnt output an uncertainty array, so make our own:</span>
    <span class="c1">#an array of the same length as mean_prediction</span>
    <span class="c1">#having values equal to the mean of the original uncertainty array</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">mean_prediction</span><span class="p">,</span> <span class="n">singleband_oid</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>  
        
    <span class="c1">#get these values into the dataframe</span>
    <span class="c1"># append the results as a dict. the list will be converted to a dataframe later.</span>
    <span class="n">lc_interpol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;objectid&quot;</span><span class="p">:</span> <span class="n">oid</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">singleband_oid</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()),</span> <span class="s2">&quot;band&quot;</span><span class="p">:</span> <span class="n">band</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">x_interpol</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
         <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="n">mean_prediction</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">}</span>
    <span class="p">)</span>
    
        
    <span class="c1">#se what this looks like on just a single light curve for now</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;zr&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">oid</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">:</span>  
        <span class="c1">#see if this looks reasonable</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_interpol</span><span class="p">,</span> <span class="n">mean_prediction</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean prediction&quot;</span><span class="p">)</span>
        <span class="c1">#plt.fill_between(</span>
        <span class="c1">#    x_interpol.ravel(),</span>
        <span class="c1">#    mean_prediction - 1.96 * std_prediction,</span>
        <span class="c1">#    mean_prediction + 1.96 * std_prediction,</span>
        <span class="c1">#    color=&quot;tab:orange&quot;,</span>
        <span class="c1">#    alpha=0.5,</span>
        <span class="c1">#    label=r&quot;95% confidence interval&quot;,</span>
        <span class="c1">#)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;flux&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;KNN regression&quot;</span><span class="p">)</span>
        
        
<span class="c1"># create a dataframe of the interpolated light curves</span>
<span class="n">df_interpol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lc_interpol</span><span class="p">)</span>
<span class="c1"># df_lc_interpol has one row per dict in lc_interpol. time and flux columns store arrays.</span>
<span class="c1"># &quot;explode&quot; the dataframe to get one row per light curve point. time and flux columns will now store floats.</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_interpol</span><span class="o">.</span><span class="n">explode</span><span class="p">([</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span><span class="s2">&quot;err&quot;</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="restructure-dataframe-in-format-expected-by-sktime">
<h3>2.6  Restructure dataframe in format expected by sktime<a class="headerlink" href="#restructure-dataframe-in-format-expected-by-sktime" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Make columns have band names in them and then remove band from the index</p></li>
<li><p>pivot the dataframe so that SKTIME understands its format</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#keep some columns out of the mix when doing the pivot by bandname</span>
<span class="c1">#set them as indices and they won&#39;t get pivoted into</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">])</span>

<span class="c1">#attach bandname to all the fluxes and uncertainties</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;band&quot;</span><span class="p">)</span>

<span class="c1">#rename the columns</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

<span class="c1">#many of these flux columns still have a space in them from the bandnames, </span>
<span class="c1">#convert that space to underscore</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> 

<span class="c1">#and get rid of that index to cleanup</span>
<span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#look at a single object to see what this array looks like</span>
<span class="n">ob_of_interest</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">singleob</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;objectid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ob_of_interest</span><span class="p">]</span>
<span class="n">singleob</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="normalize">
<h3>2.7 Normalize<a class="headerlink" href="#normalize" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>this is normalizing across all bands</p></li>
<li><p>think this is the right place to do this, rather than interpolate over time
so that the final light curves are normalized since that is the chunk of information
which goes into the ML algorithms.</p></li>
<li><p>chose max and not median or mean because there are some objects where the median flux = 0.0</p>
<ul>
<li><p>if we did this before the interpolating, the median might be a non-zero value</p></li>
</ul>
</li>
<li><p>normalizing is required so that the CLAGN and it’s comparison SDSS sample don’t have different flux levels.</p></li>
</ul>
<p>Idea here is that we normalize across each object.  So the algorithms will know, for example, that within one object W1 will be brighter than ZTF bands but from one object to the next, it will not know that one is brighter than the other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a new column with max_r_flux for each objectid</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;max_W1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;objectid&#39;</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;flux_w1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#figure out which columns in the dataframe are flux columns</span>
<span class="n">flux_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;flux&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>

<span class="c1"># make new normalized flux columns for all fluxes</span>
<span class="n">df_lc</span><span class="p">[</span><span class="n">flux_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_lc</span><span class="p">[</span><span class="n">flux_cols</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;max_W1&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="make-datetime-time-column">
<h3>2.8 Make datetime time column<a class="headerlink" href="#make-datetime-time-column" title="Link to this heading">#</a></h3>
<p>https://docs.python.org/3/library/datetime.html#module-datetime</p>
<p>SKTime wants a datetime column</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#need to convert df_lc time into datetime</span>
<span class="n">mjd</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">time</span>

<span class="c1">#convert to JD</span>
<span class="n">jd</span> <span class="o">=</span> <span class="n">mjd_to_jd</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>

<span class="c1">#convert to individual components</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;jd&#39;</span> <span class="p">)</span>

<span class="c1">#t.datetime is now an array of type datetime</span>
<span class="c1">#make it a column in the dataframe</span>
<span class="n">df_lc</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">datetime</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="save-this-dataframe">
<h3>2.9 Save this dataframe<a class="headerlink" href="#save-this-dataframe" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#save this dataframe to use for the ML below so we don&#39;t have to make it every time</span>
<span class="n">parquet_savename</span> <span class="o">=</span> <span class="s1">&#39;output/df_lc_ML.parquet&#39;</span>
<span class="n">df_lc</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">parquet_savename</span><span class="p">)</span>
<span class="c1">#print(&quot;file saved!&quot;)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="make-into-multi-index-which-is-what-sktime-expects-as-input">
<h3>2.10 make into multi-index which is what SKTime expects as input<a class="headerlink" href="#make-into-multi-index-which-is-what-sktime-expects-as-input" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_lc</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;objectid&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="prep-for-ml-algorithms-in-sktime">
<h2>3. Prep for ML algorithms in sktime<a class="headerlink" href="#prep-for-ml-algorithms-in-sktime" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># could load a previously saved file in order to plot</span>
<span class="c1">#parquet_loadname = &#39;output/df_lc_ML.parquet&#39;</span>
<span class="c1">#df_lc = MultiIndexDFObject()</span>
<span class="c1">#df_lc.data = pd.read_parquet(parquet_loadname)</span>
<span class="c1">#print(&quot;file loaded!&quot;)</span>
</pre></div>
</div>
</div>
</div>
<section id="consider-data-augmentation">
<h3>3.0 Consider data augmentation<a class="headerlink" href="#consider-data-augmentation" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>https://arxiv.org/pdf/1811.08295.pdf which has the following github</p>
<ul class="simple">
<li><p>https://github.com/gioramponi/GAN_Time_Series/tree/master</p></li>
<li><p>not easily usable</p></li>
</ul>
</li>
<li><p>https://arxiv.org/pdf/2205.06758.pdf</p></li>
<li><p>ChatGPT - give multiindex df function and it will give a starting point for augmenting</p></li>
</ol>
<p>Worried that augmenting noisy data just makes more noise</p>
</section>
<section id="train-test-split">
<h3>3.1 Train test split<a class="headerlink" href="#train-test-split" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Because thre are uneven numbers of each type (many more SDSS than CLAGN), we want to make sure to stratify evenly by type</p></li>
<li><p>Random split</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_lc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#y is defined to be the labels</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>

<span class="c1">#want a stratified split based on label</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">train_ix</span><span class="p">,</span> <span class="n">test_ix</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df_lc</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stratify</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">43</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span><span class="p">)</span>

<span class="n">train_df</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_ix</span><span class="p">]</span>  
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df_lc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_ix</span><span class="p">]</span>   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot to show how many of each type of object in the test dataset</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Objects in the Test dataset&quot;</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">test_df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">(),</span><span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;stepfilled&#39;</span><span class="p">,</span><span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#divide the dataframe into X and y for ML algorithms </span>

<span class="c1">#X is the multiindex light curve without the labels</span>
<span class="n">X_train</span>  <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>

<span class="c1">#y are the labels, should be a series </span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-that-the-data-types-are-ok-for-sktime">
<h3>3.2 Check that the data types are ok for sktime<a class="headerlink" href="#check-that-the-data-types-are-ok-for-sktime" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#ask sktime if it likes the data type of X_train</span>
<span class="kn">from</span> <span class="nn">sktime.datatypes</span> <span class="kn">import</span> <span class="n">check_is_mtype</span>

<span class="n">check_is_mtype</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="s2">&quot;pd-multiindex&quot;</span><span class="p">,</span> <span class="n">scitype</span><span class="o">=</span><span class="s2">&quot;Panel&quot;</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#check_is_mtype(X_test, mtype=&quot;pd-multiindex&quot;, scitype=&quot;Panel&quot;, return_metadata=True)</span>

<span class="c1">#This test needs to pass in order for sktime to run</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="run-machine-learning-algorithms-on-the-light-curves">
<h2>4. Run Machine Learning Algorithms on the light curves<a class="headerlink" href="#run-machine-learning-algorithms-on-the-light-curves" title="Link to this heading">#</a></h2>
<p>We choose to use <a class="reference external" href="https://www.sktime.net/en/stable/index.html">sktime</a> algorithms beacuse it is a library of many algorithms specifically tailored to time series datasets.  It is based on the sklearn library so syntax is familiar to many users.</p>
<p>Types of classifiers are listed <a class="reference external" href="https://www.sktime.net/en/stable/api_reference/classification.html">here</a>.</p>
<p>This notebook will invert the actual workflow and show you a single example of the algorithm which best fits the data and has the most accurate classifier. Then it will show how to write a for loop over a bunch of classifiers before narrowing it down to the most accurate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#what is the list of all possible classifiers that work with multivariate data</span>
<span class="c1">#all_tags(estimator_types = &#39;classifier&#39;)</span>
<span class="n">classifiers</span> <span class="o">=</span> <span class="n">all_estimators</span><span class="p">(</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span> <span class="n">filter_tags</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;capability:multivariate&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
<span class="n">classifiers</span>
</pre></div>
</div>
</div>
</div>
<section id="the-most-accurate-classifier">
<h3>4.1 The Most Accurate Classifier<a class="headerlink" href="#the-most-accurate-classifier" title="Link to this heading">#</a></h3>
<p>See section 4.2 for how we landed with this algorithm</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1">#looks like RandomIntervalClassifier is performing the best for the CLAGN (not for the SDSS)</span>

<span class="c1">#setup the classifier</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">RandomIntervalClassifier</span><span class="p">(</span><span class="n">n_intervals</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">43</span><span class="p">)</span>

<span class="c1">#fit the classifier on the training dataset</span>
<span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1">#make predictions on the test dataset using the trained model </span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy of Random Interval Classifier: </span><span class="si">{</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="w"> </span><span class="n">y_pred</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#plot a confusion matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="n">disp</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span><span class="n">display_labels</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="n">disp</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loop-over-a-bunch-of-classifiers">
<h3>4.2 Loop over a bunch of classifiers<a class="headerlink" href="#loop-over-a-bunch-of-classifiers" title="Link to this heading">#</a></h3>
<p>Our method is to do a cursory check of a bunch of classifiers and then later drill down deeper on anything with good initial results.  We choose to run a loop over ~10 classifiers that seem promising and check the accuracy scores for each one.  Any classifier with a promising accuracy score could then be followed up with detailed hyperparameter tuning, or potentially with considering other classifiers in that same type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>
<span class="c1">#which classifiers are we interestd in</span>
<span class="c1">#roughly one from each type of classifier</span>

<span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Arsenal&quot;</span><span class="p">,</span>                     <span class="c1">#kernel based</span>
        <span class="s2">&quot;RocektClassifier&quot;</span><span class="p">,</span>             <span class="c1">#kernel based</span>
        <span class="s2">&quot;CanonicalIntervalForest&quot;</span><span class="p">,</span>      <span class="c1">#interval based</span>
        <span class="s2">&quot;HIVECOTEV2&quot;</span><span class="p">,</span>                   <span class="c1">#hybrid</span>
<span class="c1">#        &quot;CNNClassifier&quot;,               #Deep Learning  - **requires tensorflow which is giving import errors</span>
<span class="c1">#        &quot;WeightedEnsembleClassifier&quot;,   #Ensemble - **maybe use in the future if we find good options</span>
        <span class="s2">&quot;IndividualTDE&quot;</span><span class="p">,</span>               <span class="c1">#Dictionary-based</span>
        <span class="s2">&quot;KNeighborsTimeSeriesClassifier&quot;</span><span class="p">,</span> <span class="c1">#Distance Based</span>
        <span class="s2">&quot;RandomIntervalClassifier&quot;</span><span class="p">,</span>     <span class="c1">#Feature based</span>
        <span class="s2">&quot;Catch22Classifier&quot;</span><span class="p">,</span>            <span class="c1">#Feature based</span>
        <span class="s2">&quot;ShapeletTransformClassifier&quot;</span>   <span class="c1">#Shapelet based</span>
        <span class="s2">&quot;DummyClassifier&quot;</span><span class="p">]</span>             <span class="c1">#Dummy - ignores input</span>

<span class="c1">#for those with an impossible time limit, how long to let them run for before cutting off</span>
<span class="n">nmins</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1">#these could certainly be more tailored</span>
<span class="n">classifier_call</span> <span class="o">=</span> <span class="p">[</span><span class="n">Arsenal</span><span class="p">(</span><span class="n">time_limit_in_minutes</span><span class="o">=</span><span class="n">nmins</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
                  <span class="n">RocketClassifier</span><span class="p">(</span><span class="n">num_kernels</span><span class="o">=</span><span class="mi">2000</span><span class="p">),</span>
                  <span class="n">CanonicalIntervalForest</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                  <span class="n">HIVECOTEV2</span><span class="p">(</span><span class="n">time_limit_in_minutes</span><span class="o">=</span><span class="n">nmins</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<span class="c1">#                  CNNClassifier(),</span>
<span class="c1">#                  WeightedEnsembleClassifier(),</span>
                  <span class="n">IndividualTDE</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
                  <span class="n">KNeighborsTimeSeriesClassifier</span><span class="p">(</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                  <span class="n">RandomIntervalClassifier</span><span class="p">(</span><span class="n">n_intervals</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">43</span><span class="p">),</span>
                  <span class="n">Catch22Classifier</span><span class="p">(</span><span class="n">outlier_norm</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">43</span><span class="p">),</span>
                  <span class="n">ShapeletTransformClassifier</span><span class="p">(</span><span class="n">time_limit_in_minutes</span><span class="o">=</span><span class="n">nmins</span><span class="p">,</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                  <span class="n">DummyClassifier</span><span class="p">()]</span>

<span class="c1">#setup to store the accuracy scores</span>
<span class="n">accscore_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># iterate over classifiers</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">classifier_call</span><span class="p">)):</span>
    <span class="c1">#fit the classifier</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    
    <span class="c1">#make predictions on the test dataset</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1">#calculate and track accuracy score</span>
    <span class="n">accscore</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy of </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> classifier: </span><span class="si">{</span><span class="n">accscore</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">accscore_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">accscore</span>
    
    <span class="c1">#plot confusion matrix</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span><span class="n">display_labels</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">disp</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#just for keeping track, I also tried </span>
<span class="c1">#clf = SignatureClassifier(depth = 2, window_depth = 3, random_state = 43)</span>
<span class="c1">#this fails to complete, and is a known limitation of this algorithm.  </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#show the summary of the algorithms used and their accuracy score</span>
<span class="n">accscore_dict</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="conclusions">
<h2>5.0 Conclusions:<a class="headerlink" href="#conclusions" title="Link to this heading">#</a></h2>
<p>This classifier can be used to predict CLAGN.  The feature based algorithms do the best jobs of having little to no predicted CLAGN that are truly normal SDSS quasars.  We infer then that if the trained model predicts CLAGN, it is a very good target for follow-up spectroscopy to confirm CLAGN.  However this algorthim will not catch all CLAGN, and will incorrectly labels some CLAGN as being normal SDSS quasars.  THis algorithm can therefore not be used to find a complete sample of CLAGN, but can be used to increase the known sample.</p>
<section id="potential-areas-of-improvement">
<h3>5.1 Potential Areas of improvement<a class="headerlink" href="#potential-areas-of-improvement" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Data is messy</p>
<ul>
<li><p>ZTF calibration??</p></li>
</ul>
</li>
<li><p>Label inaccuracy is a concern</p>
<ul>
<li><p>mostly SDSS,</p></li>
<li><p>but CLAGN papers all have different selection criteria</p></li>
</ul>
</li>
<li><p>Not enough data on CLAGN</p>
<ul>
<li><p>limited number of lightcurves</p></li>
<li><p>consider data augmentation</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="light_curve_generator.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Make Multiwavelength Light Curves Using Archival Data</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-goals">Learning Goals</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input">Input</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgements">Acknowledgements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-a-dataset-of-archival-light-curves">1. Read in a dataset of archival light curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-prep">2. Data Prep</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-bands-with-not-enough-data">2.1 Remove bands with not enough data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combine-labels-for-a-simpler-classification">2.2 Combine Labels for a Simpler Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-bad-data">2.3 Remove “bad”  data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incomplete-data">2.4 Incomplete Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-data">2.5 Missing Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-all-objects-and-bands-have-identical-time-arrays-uniform-length-and-spacing">2.5  Make all objects and bands have identical time arrays (uniform length and spacing)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restructure-dataframe-in-format-expected-by-sktime">2.6  Restructure dataframe in format expected by sktime</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#normalize">2.7 Normalize</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-datetime-time-column">2.8 Make datetime time column</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-this-dataframe">2.9 Save this dataframe</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-into-multi-index-which-is-what-sktime-expects-as-input">2.10 make into multi-index which is what SKTime expects as input</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prep-for-ml-algorithms-in-sktime">3. Prep for ML algorithms in sktime</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#consider-data-augmentation">3.0 Consider data augmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split">3.1 Train test split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#check-that-the-data-types-are-ok-for-sktime">3.2 Check that the data types are ok for sktime</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-machine-learning-algorithms-on-the-light-curves">4. Run Machine Learning Algorithms on the light curves</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-most-accurate-classifier">4.1 The Most Accurate Classifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loop-over-a-bunch-of-classifiers">4.2 Loop over a bunch of classifiers</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">5.0 Conclusions:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#potential-areas-of-improvement">5.1 Potential Areas of improvement</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Fornax developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022-2023, Fornax developers.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>